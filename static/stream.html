<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>WebRTC Color Sender</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
            overflow: hidden;
            font-family: sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            height: 100%;
            width: 100%;
            background-color: #f4f4f4;
        }

        .header {
            flex: 0 0 5%;
            padding: 1em;
            background-color: #007bff;
            color: #fff;
            width: 100%;
            text-align: center;
        }

        .header h2 {
            font-size: 2em;
        }

        .video-container {
            flex: 1 1 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 95%;
        }

        video {
            width: 100%;
            height: 80%;
            border: 2px solid #333;
        }

        .footer {
            flex: 0 0 10%;
            padding: 1em;
            width: 100%;
            text-align: center;
        }

        button {
            padding: 1.5em 0;
            font-size: 3em;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            width: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        #status {
            margin-top: 1em;
            font-size: 2em;
            color: #555;
        }

        input {
            padding: 0.5em;
            font-size: 1.5em;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin-top: 0.5em;
            width: 100%;
            max-width: 400px;
        }

        label {
            font-size: 1.2em;
            color: #333;
            margin-top: 0.5em;
            display: block;
        }

        select {
            padding: 0.5em;
            font-size: 1.5em;
            border: 2px solid #007bff;
            border-radius: 5px;
            margin-top: 0.5em;
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h2>WebRTC Cámara y Micro</h2>
        </div>
        <div class="video-container">
            <video id="localVideo" autoplay muted playsinline></video>
        </div>
        <div class="footer">
            <label for="channelCode">Código del canal:</label>
            <input type="text" id="channelCode" placeholder="Introduce el código del canal">
            <label for="cameraSelect">Selecciona la cámara:</label>
            <select id="cameraSelect">
                <option value="user">Cámara Frontal</option>
                <option value="environment">Cámara Trasera</option>
            </select>
            <button id="sendBtn">Enviar cámara y micro por WebRTC</button>
            <div id="status"></div>
        </div>

        <script>
            const video = document.getElementById('localVideo');
            const sendBtn = document.getElementById('sendBtn');
            const statusDiv = document.getElementById('status');
            const channelCodeInput = document.getElementById('channelCode');
            const cameraSelect = document.getElementById('cameraSelect');
            let pc = null;
            let currentStream = null;

            sendBtn.onclick = async () => {
                const channelCode = channelCodeInput.value.trim();
                if (!channelCode) {
                    alert('Por favor, introduce un código de canal.');
                    return;
                }

                sendBtn.disabled = true;
                statusDiv.textContent = 'Solicitando cámara y micro...';

                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    alert('Tu navegador no soporta acceso a la cámara. Por favor, usa un navegador actualizado.');
                    return;
                }

                // Usar el deviceId seleccionado
                const deviceId = cameraSelect.value;

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: deviceId } },
                        audio: true
                    });
                    video.srcObject = stream;
                    currentStream = stream;
                    statusDiv.textContent = 'Cámara y micro capturados. Iniciando WebRTC...';

                    pc = new RTCPeerConnection();
                    stream.getTracks().forEach(track => {
                        pc.addTrack(track, stream);
                    });

                    const offer = await pc.createOffer();
                    await pc.setLocalDescription(offer);

                    const resp = await fetch(`/stream?code=${encodeURIComponent(channelCode)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: offer.type,
                            sdp: offer.sdp
                        })
                    });

                    if (!resp.ok) {
                        const errorText = await resp.text();
                        statusDiv.textContent = `Error: ${errorText}`;
                        sendBtn.disabled = false;
                        return;
                    }

                    const answer = await resp.json();
                    await pc.setRemoteDescription(answer);
                    statusDiv.textContent = 'WebRTC conectado. Enviando cámara y micro.';
                } catch (err) {
                    if (err.name === 'NotAllowedError') {
                        alert('Permiso denegado para acceder a la cámara y el micrófono.');
                    } else if (err.name === 'NotFoundError') {
                        alert('No se encontró una cámara o micrófono disponible.');
                    } else {
                        alert('Error al acceder a la cámara: ' + err.message);
                    }
                    sendBtn.disabled = false;
                }
            };

            // Cambiar de cámara y actualizar la transmisión
            async function switchCamera() {
                const deviceId = cameraSelect.value;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { deviceId: { exact: deviceId } },
                        audio: true
                    });

                    // Detener el flujo anterior
                    if (currentStream) {
                        currentStream.getTracks().forEach(track => track.stop());
                    }

                    video.srcObject = stream;
                    currentStream = stream;

                    // Actualizar la conexión WebRTC con el nuevo flujo
                    if (pc) {
                        // Remover los tracks antiguos
                        pc.getSenders().forEach(sender => pc.removeTrack(sender));

                        // Agregar los nuevos tracks
                        stream.getTracks().forEach(track => pc.addTrack(track, stream));

                        statusDiv.textContent = `Cámara cambiada y transmisión actualizada.`;
                    } else {
                        statusDiv.textContent = `Cámara cambiada, pero no hay conexión activa.`;
                    }
                } catch (err) {
                    alert('Error al cambiar de cámara: ' + err.message);
                }
            }

            // Listar cámaras disponibles
            async function listAvailableCameras() {
                try {
                    // Solicitar permisos de cámara para garantizar que se detecten los dispositivos
                    await navigator.mediaDevices.getUserMedia({ video: true });

                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');

                    cameraSelect.innerHTML = '';

                    videoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        option.textContent = device.label || `Cámara ${index + 1}`;
                        cameraSelect.appendChild(option);
                    });

                    if (videoDevices.length === 0) {
                        statusDiv.textContent = 'No se detectaron cámaras disponibles.';
                    }
                } catch (err) {
                    console.error('Error al listar cámaras:', err);
                    statusDiv.textContent = 'Error al listar cámaras. Asegúrate de otorgar permisos.';
                }
            }

            listAvailableCameras();
            cameraSelect.addEventListener('change', switchCamera);
        </script>
    </div>
</body>

</html>